{% extends "base.html" %}

{% block title %}{{ video.title }} - VidStream{% endblock %}

{% block content %}
<div class="container">
    <div class="video-page">
        <div class="video-section">
            <div class="video-player">
                <img src="{{ url_for('static', filename='uploads/' + video.thumbnail_path) }}" alt="{{ video.title }}">
            </div>
            <div class="video-details">
                <h1 class="video-title-large">{{ video.title }}</h1>
                <div class="video-stats">
                    <span class="stat">
                        <i class="fas fa-eye"></i> {{ video.views }} views
                    </span>
                    <span class="stat">
                        <i class="far fa-clock"></i> {{ video.created_at|timeago }}
                    </span>
                </div>
                <div class="video-author-section">
                    <div class="author-info">
                        <i class="fas fa-user-circle author-avatar"></i>
                        <span class="author-name">{{ video.username }}</span>
                    </div>
                </div>
                {% if video.description %}
                    <div class="video-description">
                        <h3><i class="fas fa-info-circle"></i> Description</h3>
                        <p>{{ video.description }}</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="comments-section">
            <h2 class="comments-title">
                <i class="fas fa-comments"></i> Comments
            </h2>
            
            {% if session.get('user_id') %}
                <form method="POST" action="{{ url_for('add_comment', video_id=video.video_id) }}" class="comment-form">
                    <div class="comment-input-wrapper">
                        <i class="fas fa-user-circle comment-avatar"></i>
                        <textarea name="content" placeholder="Add a comment..." required class="comment-input" rows="2"></textarea>
                    </div>
                    <div class="comment-actions">
                        <button type="submit" class="btn btn-primary btn-sm">
                            <i class="fas fa-paper-plane"></i> Comment
                        </button>
                    </div>
                </form>
            {% else %}
                <div class="login-prompt">
                    <p><i class="fas fa-info-circle"></i> Please <a href="{{ url_for('login') }}">login</a> to comment.</p>
                </div>
            {% endif %}

            <div class="comments-list">
                {% if comments %}
                    {% for comment in comments %}
                        <div class="comment">
                            <div class="comment-header">
                                <i class="fas fa-user-circle comment-avatar"></i>
                                <div class="comment-meta">
                                    <span class="comment-author">{{ comment.username }}</span>
                                    <span class="comment-time">{{ comment.created_at|timeago }}</span>
                                </div>
                            </div>
                            <div class="comment-content">
                                {{ comment.content }}
                            </div>
                            
                            {% if session.get('user_id') %}
                                <div class="comment-actions-bar">
                                    <button class="btn-text reply-toggle" data-comment-id="{{ comment.comment_id }}">
                                        <i class="fas fa-reply"></i> Reply
                                    </button>
                                </div>
                                
                                <div id="reply-form-{{ comment.comment_id }}" class="reply-form" style="display: none;">
                                    <form method="POST" action="{{ url_for('add_reply', comment_id=comment.comment_id) }}">
                                        <input type="hidden" name="video_id" value="{{ video.video_id }}">
                                        <div class="comment-input-wrapper">
                                            <i class="fas fa-user-circle comment-avatar-sm"></i>
                                            <textarea name="content" placeholder="Add a reply... (use @username to mention)" required class="comment-input reply-input" rows="2"></textarea>
                                        </div>
                                        <div class="comment-actions">
                                            <button type="button" class="btn btn-secondary btn-sm reply-cancel" data-comment-id="{{ comment.comment_id }}">
                                                Cancel
                                            </button>
                                            <button type="submit" class="btn btn-primary btn-sm">
                                                <i class="fas fa-paper-plane"></i> Reply
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            {% endif %}

                            {% if comment.replies %}
                                <div class="replies">
                                    {% for reply in comment.replies %}
                                        <div class="reply">
                                            <div class="comment-header">
                                                <i class="fas fa-user-circle comment-avatar-sm"></i>
                                                <div class="comment-meta">
                                                    <span class="comment-author">{{ reply.username }}</span>
                                                    {% if reply.mentioned_username %}
                                                        <i class="fas fa-arrow-right"></i>
                                                        <span class="mentioned-user">@{{ reply.mentioned_username }}</span>
                                                    {% endif %}
                                                    <span class="comment-time">{{ reply.created_at|timeago }}</span>
                                                </div>
                                            </div>
                                            <div class="comment-content">
                                                {{ reply.content }}
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-comments">
                        <i class="far fa-comment-dots"></i>
                        <p>No comments yet. Be the first to comment!</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    // Toggle reply forms
    document.querySelectorAll('.reply-toggle').forEach(button => {
        button.addEventListener('click', function() {
            const commentId = this.dataset.commentId;
            const replyForm = document.getElementById(`reply-form-${commentId}`);
            replyForm.style.display = replyForm.style.display === 'none' ? 'block' : 'none';
            if (replyForm.style.display === 'block') {
                replyForm.querySelector('textarea').focus();
            }
        });
    });

    // Cancel reply
    document.querySelectorAll('.reply-cancel').forEach(button => {
        button.addEventListener('click', function() {
            const commentId = this.dataset.commentId;
            const replyForm = document.getElementById(`reply-form-${commentId}`);
            replyForm.style.display = 'none';
            replyForm.querySelector('textarea').value = '';
        });
    });
</script>
{% endblock %}
